CONTAINER_NAME = python_dev_env
.PHONY: help build start stop run simulate notebook install shell lint lint-fix lint-unsafe format clean-code prune pre-commit-install

.DEFAULT_GOAL := help

help:
	@echo ""
	@echo "Makefile de Ayuda para el Proyecto Tres en Raya"
	@echo "------------------------------------------------"
	@echo "Uso: make [target]"
	@echo ""
	@echo "üéØ Targets Principales:"
	@printf "  \033[36m%-18s\033[0m %s\n" "build" "Construye la imagen y levanta el contenedor por primera vez."
	@printf "  \033[36m%-18s\033[0m %s\n" "start" "Inicia el contenedor si est√° detenido."
	@printf "  \033[36m%-18s\033[0m %s\n" "stop" "Detiene y elimina el contenedor."
	@printf "  \033[36m%-18s\033[0m %s\n" "run" "Jugar: Ejecuta la interfaz gr√°fica (src/main.py)."
	@printf "  \033[36m%-18s\033[0m %s\n" "simulate" "Estad√≠sticas: Ejecuta las simulaciones (src/simulate.py)."
	@printf "  \033[36m%-18s\033[0m %s\n" "notebook" "An√°lisis: Lanza Jupyter Lab en el navegador."
	@echo ""
	@echo "üíé Calidad de C√≥digo (Ruff):"
	@printf "  \033[36m%-18s\033[0m %s\n" "lint" "Solo revisa errores (sin modificar nada)."
	@printf "  \033[36m%-18s\033[0m %s\n" "lint-fix" "Revisa y ARREGLA errores seguros (imports, estilo)."
	@printf "  \033[36m%-18s\033[0m %s\n" "lint-unsafe" "LIMPIEZA PROFUNDA: Borra variables no usadas (agresivo)."
	@printf "  \033[36m%-18s\033[0m %s\n" "format" "Re-ordena el c√≥digo para que se vea bonito."
	@printf "  \033[36m%-18s\033[0m %s\n" "clean-code" "Combo: Ejecuta format + lint-fix."
	@echo ""
	@echo "üõ†Ô∏è Desarrollo y Configuraci√≥n:"
	@printf "  \033[36m%-18s\033[0m %s\n" "install" "Sincroniza dependencias (uv sync)."
	@printf "  \033[36m%-18s\033[0m %s\n" "shell" "Entra a la terminal del contenedor."
	@printf "  \033[36m%-18s\033[0m %s\n" "pre-commit-install" "Instala los git hooks para chequeo autom√°tico."
	@printf "  \033[36m%-18s\033[0m %s\n" "prune" "¬°PELIGRO! Borra todas las im√°genes y contenedores de Podman."
	@echo ""

# --- Construcci√≥n y Ejecuci√≥n ---

build: ## Construye y levanta el contenedor desde cero
	@echo "-> Construyendo y levantando el entorno de desarrollo..."
	@podman-compose up -d --build
	@make install

start: ## Inicia el contenedor si ya existe
	@echo "-> Iniciando el contenedor..."
	@podman-compose up -d

stop: ## Detiene y elimina el contenedor
	@echo "-> Deteniendo el contenedor..."
	@podman-compose down

run: ## Ejecuta el script principal
	@echo "-> Concediendo acceso a la pantalla (X11)..."
	@xhost +local:
	@echo "-> Ejecutando el juego..."
	@podman exec -it $(CONTAINER_NAME) uv run src/main.py

simulate: ## Ejecuta una simulaci√≥n de N partidas para recolectar datos
	@echo "-> Iniciando la simulaci√≥n estad√≠stica (esto puede tardar)..."
	@podman exec -it $(CONTAINER_NAME) uv run src/simulate.py

notebook: ## Lanza un servidor de Jupyter Lab para el an√°lisis de datos
	@echo "-> Lanzando servidor de Jupyter Lab..."
	@echo "-> Copia la URL que aparecer√° a continuaci√≥n en tu navegador."
	@podman exec -it $(CONTAINER_NAME) jupyter lab \
		--ip=0.0.0.0 \
		--port=8888 \
		--no-browser \
		--allow-root

# --- Gesti√≥n de Dependencias y Entorno ---

install: ## Sincroniza las dependencias (main Y dev)
	@echo "-> Sincronizando dependencias con uv (incluyendo --dev)..."
	@podman exec -it $(CONTAINER_NAME) uv sync --dev

shell: ## Entra al contenedor
	@echo "-> Abriendo terminal en el contenedor '$(CONTAINER_NAME)'..."
	@podman exec -it $(CONTAINER_NAME) /bin/bash

pre-commit-install: ## Instala los git hooks en tu repositorio local
	@echo "-> Instalando git hooks con pre-commit..."
	@podman exec -it $(CONTAINER_NAME) pre-commit install

prune: ## Limpieza profunda de Podman
	@echo "-> Limpiando el sistema Podman (im√°genes, contenedores, vol√∫menes)..."
	@podman system prune -a --volumes --force

# --- Calidad de C√≥digo y Limpieza (Ruff) ---

lint: ## Solo revisa, no toca nada
	@echo "-> Revisando el c√≥digo con Ruff (Solo lectura)..."
	@podman exec -it $(CONTAINER_NAME) ruff check .

lint-fix: ## Arregla cosas seguras (imports, espacios)
	@echo "-> Aplicando correcciones seguras con Ruff..."
	@podman exec -it $(CONTAINER_NAME) ruff check . --fix

lint-unsafe: ## Arregla variables no usadas (Agresivo)
	@echo "-> Aplicando correcciones AGRESIVAS (variables no usadas)..."
	@podman exec -it $(CONTAINER_NAME) ruff check . --fix --unsafe-fixes

format: ## Formatea el c√≥digo
	@echo "-> Formateando el c√≥digo con Ruff..."
	@podman exec -it $(CONTAINER_NAME) ruff format .

clean-code: ## Combo: Formatear y Arreglar
	@echo "-> Limpiando y embelleciendo todo el c√≥digo..."
	@make format
	@make lint-fix
